heat_template_version: 2013-05-23

description: >

  HOT template to create a customized Sandvine Stack, it have two Instances acting as a L2 Bridge between two networks.

  We have 4 Instances:

  * 2 SVPTS - CentOS 7
  * 1 SVSDE - CentOS 7
  * 1 SVSPB - CentOS 6


  We want to wire them as:

  -------|ctrl_subnet|------------- Control Network (with Internet access via router_i0)
      |        |    |    |
     ---      ---   |   ---
     | |      | |   |   |S| 
     | |      | |   |   |V|----- Traffic Generator - Side A
     | |      | |   |   |P|
     | |      | |   |   |T|
     | |      | |   |   |S|
     | |      | |   |   | |
     |S|      |S|   |   |1|
     |V|      |V|   |   ---
     |S|      |S|   |    |
     |P|      |D|   |    | <-- Fake Internet connection between SVPTS 1 and 2
     |B|      |E|   |    |
     | |      | |   |   ---
     | |      | |   |   |S|
     | |      | |   |   |V|
     | |      | |   ----|P|
     | |      | |       |T|
     | |      | |       |S|
     | |      | |       | |----- Traffic Generator - Side B
     | |      | |       |2|
     ---      ---       ---
      |        |         |
      --|service_subnet|------  <-- Service Network (not routed - no gateway)

parameters:
  # SSH Keypair
  ssh_key:
    type: string
    label: "Your SSH keypair name (pre-create please!)"
    description: |
        If you have not created your key, please go to
        Project/Compute/Access & Security, and either import
        one or create one. If you create it, make sure you keep
        the downloaded file (as you don't get a second chance)
    default: default

  # Valid IP Network on the Internet
  public_network:
    type: string
    label: Public External Network
    description: Public Network with Floating IP addresses
    default: "ext-net"

  # Stack Images
  svpts_image:
    type: string
    label: "SVPTS Image (default '{{svpts_image}}')"
    description: "SVPTS Image"
    default: "{{svpts_image}}"

  svsde_image:
    type: string
    label: "SVSDE Image (default '{{svsde_image}}')"
    description: "SVSDE Image"
    default: "{{svsde_image}}"

  svspb_image:
    type: string
    label: "SVSPB Image (default '{{svspb_image}}')"
    description: "SVSPB Image"
    default: "{{svspb_image}}"

resources:
  # Neutron Routers
  rtr_0:
    type: OS::Neutron::Router
    properties:
      admin_state_up: True
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-rtr-0' } }
      external_gateway_info:
        network: { get_param: public_network }

  # Router's ports
  router_i0:
    type: OS::Neutron::RouterInterface
    properties:
      router: { get_resource: rtr_0 }
      subnet: { get_resource: ctrl_subnet }

  # Floating IP of each Virtual Machine / Instances
  floating_ip_1:
    type: OS::Neutron::FloatingIP
    depends_on: router_i0
    properties:
      floating_network: { get_param: public_network }

  floating_ip_2:
    type: OS::Neutron::FloatingIP
    depends_on: router_i0
    properties:
      floating_network: { get_param: public_network }

  floating_ip_3:
    type: OS::Neutron::FloatingIP
    depends_on: router_i0
    properties:
      floating_network: { get_param: public_network }

  floating_ip_4:
    type: OS::Neutron::FloatingIP
    depends_on: router_i0
    properties:
      floating_network: { get_param: public_network }

  # Security Groups / OpenStack's Firewall Layer
  subscriber_default_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-subscriber-default-sec' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 22
          port_range_max: 22
        - protocol: tcp
          port_range_min: 80
          port_range_max: 80
        - protocol: tcp
          port_range_min: 443
          port_range_max: 443
        - protocol: tcp
          port_range_min: 3389
          port_range_max: 3389

  svsde_ctrl_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svsde-ctrl-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 22
          port_range_max: 22
        - protocol: tcp
          port_range_min: 80
          port_range_max: 80
        - protocol: tcp
          port_range_min: 443
          port_range_max: 443

  svsde_srvc_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svsde-srvc-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 1
          port_range_max: 65535
        - protocol: udp
          port_range_min: 1
          port_range_max: 65535

  svspb_ctrl_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svspb-ctrl-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 22
          port_range_max: 22

  svspb_srvc_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svspb-srvc-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 1
          port_range_max: 65535
        - protocol: udp
          port_range_min: 1
          port_range_max: 65535

  svpts_ctrl_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svpts-ctrl-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 22
          port_range_max: 22

  svpts_srvc_sec:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svpts-srvc-rules' } }
      rules:
        - protocol: icmp
        - protocol: tcp
          port_range_min: 1
          port_range_max: 65535
        - protocol: udp
          port_range_min: 1
          port_range_max: 65535

  # Control Network
  ctrl_net:
    type: OS::Neutron::Net
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-control' } }

  # Control Subnet
  ctrl_subnet:
    type: OS::Neutron::Subnet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-control' } }
      dns_nameservers: [8.8.4.4, 8.8.8.8]
      network: { get_resource: ctrl_net }
      enable_dhcp: True
      cidr: 192.168.192.0/25
      allocation_pools:
        - start: 192.168.192.50
          end: 192.168.192.126

  # Service Network
  service_net:
    type: OS::Neutron::Net
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-service' } }

  # Service Subnet
  service_subnet:
    type: OS::Neutron::Subnet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-service' } }
      network: { get_resource: service_net }
      enable_dhcp: True
      cidr: 192.168.192.128/25
      gateway_ip: ""

  # Subscribers Network 1
  data_sub_net1:
    type: OS::Neutron::ProviderNet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-subscribers-1-vlan-{{vlan_sub_id}}' } }
      network_type: vlan
      physical_network: {{physical_network1_label}}
      segmentation_id: {{vlan_sub_id}}
      shared: false

  # Subscribers Subnet 1, can be ignored - not used
  data_sub_subnet1:
    type: OS::Neutron::Subnet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-subscribers-1' } }
      dns_nameservers: [8.8.4.4, 8.8.8.8]
      network: { get_resource: data_sub_net1 }
      enable_dhcp: True
      cidr: 10.192.0.0/16
      gateway_ip: 10.192.0.1
      allocation_pools:
        - start: 10.192.0.50
          end: 10.192.255.254

  # Subscribers Network 2
  data_sub_net2:
    type: OS::Neutron::ProviderNet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-subscribers-2-vlan-{{vlan_sub2_id}}' } }
      network_type: vlan
      physical_network: {{physical_network2_label}}
      segmentation_id: {{vlan_sub2_id}}
      shared: false

  # Subscribers Subnet 2, can be ignored - not used
  data_sub_subnet2:
    type: OS::Neutron::Subnet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-subscribers-2' } }
      network: { get_resource: data_sub_net2 }
      enable_dhcp: False
      cidr: 10.192.0.0/16
      allocation_pools:
        - start: 10.192.0.2
          end: 10.192.0.29

  # "Internet" Network between two SVPTS
  data_int_middle_net1:
    type: OS::Neutron::ProviderNet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-data-internet-middle-1-vlan-{{vlan_middle_id}}' } }
      network_type: vlan
      physical_network: {{physical_network3_label}}
      segmentation_id: {{vlan_middle_id}}
      shared: false

  # "Internet" Subnet, can be ignored - not used
  data_int_middle_subnet1:
    type: OS::Neutron::Subnet
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-data-internet-middle-1' } }
      network: { get_resource: data_int_middle_net1 }
      enable_dhcp: False
      cidr: 10.192.0.0/16
      allocation_pools:
        - start: 10.192.0.30
          end: 10.192.0.49

  # SVSPB's Control Port at the internal switch
  svspb_ctrl_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svspb-port"]]}
      network: { get_resource: ctrl_net }
      fixed_ips:
        - ip_address: 192.168.192.10
      security_groups:
        - { get_resource: svspb_ctrl_sec }

  # SVSPB's Control Port Floating IP at the public Switch
  svspb_floating_ip_assoc:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_resource: floating_ip_3 }
      port_id: { get_resource: svspb_ctrl_port }

  # SVSDE's Control Port at the internal switch
  svsde_ctrl_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svsde-port"]]}
      network: { get_resource: ctrl_net }
      fixed_ips:
        - ip_address: 192.168.192.20
      security_groups:
        - { get_resource: svsde_ctrl_sec }

  # SVSDE's Control Port Floating IP at the public Switch
  svsde_floating_ip_assoc:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_resource: floating_ip_2 }
      port_id: { get_resource: svsde_ctrl_port }

  # SVPTS 1's Control Port at the internal switch
  svpts_ctrl_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts-port"]]}
      network: { get_resource: ctrl_net }
      fixed_ips:
        - ip_address: 192.168.192.30
      security_groups:
        - { get_resource: svpts_ctrl_sec }

  # SVPTS 1's Control Port Floating IP at the public Switch
  svpts_floating_ip_assoc:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_resource: floating_ip_1 }
      port_id: { get_resource: svpts_ctrl_port }

  # SVPTS 2's Control Port at the internal switch
  svpts2_ctrl_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts2-ctrl-port"]]}
      network: { get_resource: ctrl_net }
      fixed_ips:
        - ip_address: 192.168.192.31
      security_groups:
        - { get_resource: svpts_ctrl_sec }

  # SVPTS 2's Control Port Floating IP at the public Switch
  svpts2_floating_ip_assoc:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_resource: floating_ip_4 }
      port_id: { get_resource: svpts2_ctrl_port }

  # Services Ports
  svspb_srvc_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svspb-port"]]}
      network: { get_resource: service_net }
      fixed_ips:
        - ip_address: 192.168.192.130

  svsde_srvc_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svsde-port"]]}
      network: { get_resource: service_net }
      fixed_ips:
       - ip_address: 192.168.192.140
 
  svpts_srvc_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts-port"]]}
      network: { get_resource: service_net }
      fixed_ips:
        - ip_address: 192.168.192.150

  svpts2_srvc_port:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts2-port"]]}
      network: { get_resource: service_net }
      fixed_ips:
        - ip_address: 192.168.192.151

  # SVPTS 1 "cables" for both Subscriber and Internet are wired on these ports:
  svpts_port_int_middle_net1:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts1-i1-port"]]}
      network: { get_resource: data_int_middle_net1 }
      port_security_enabled: False

  # SVPTS 1 Subscribers 1, wired against physvlanp3p3
  svpts_port_sub_side1_net1:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts1-s1-port"]]}
      network: { get_resource: data_sub_net1 }
      port_security_enabled: False

  # SVPTS 2 "cables" for both Subscriber and Internet are wired on these ports:
  svpts2_port_int_middle_net1:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts2-i1-port"]]}
      network: { get_resource: data_int_middle_net1 }
      port_security_enabled: False

  # SVPTS 2 Subscribers 2, wired against physvlanp3p4
  svpts2_port_sub_side2_net1:
    type: OS::Neutron::Port
    properties:
      name: {"Fn::Join": ["-", [{ get_param: "OS::stack_name" } , "svpts2-s2-port"]]}
      network: { get_resource: data_sub_net2 }
      port_security_enabled: False

  # SVPTS 1
  svpts_1:
    type: OS::Nova::Server
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svpts-1' } }
      key_name: { get_param: 'ssh_key' }
      image: { get_param: 'svpts_image' }
      flavor: "m1.small"
      networks:
        - port: { get_resource: svpts_ctrl_port }
        - port: { get_resource: svpts_srvc_port }
        - port: { get_resource: svpts_port_sub_side1_net1 }
        - port: { get_resource: svpts_port_int_middle_net1 }
      user_data_format: RAW
      user_data: |
        #cloud-config
        system_info:
          default_user:
            name: "sandvine"
        chpasswd:
          list: |
            root:sandvine
            sandvine:sandvine
          expire: False

  # SVPTS 2
  svpts_2:
    type: OS::Nova::Server
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svpts-2' } }
      key_name: { get_param: 'ssh_key' }
      image: { get_param: 'svpts_image' }
      flavor: "m1.small"
      networks:
        - port: { get_resource: svpts2_ctrl_port }
        - port: { get_resource: svpts2_srvc_port }
        - port: { get_resource: svpts2_port_sub_side2_net1 }
        - port: { get_resource: svpts2_port_int_middle_net1 }
      user_data_format: RAW
      user_data: |
        #cloud-config
        system_info:
          default_user:
            name: "sandvine"
        chpasswd:
          list: |
            root:sandvine
            sandvine:sandvine
          expire: False

  # SVSPB 1
  svspb_1:
    type: OS::Nova::Server
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svspb-1' } }
      key_name: { get_param: 'ssh_key' }
      image: { get_param: 'svspb_image' }
      flavor: "m1.medium"
      networks:
        - port: { get_resource: svspb_ctrl_port }
        - port: { get_resource: svspb_srvc_port }
      user_data_format: RAW
      user_data: |
        #cloud-config
        system_info:
          default_user:
            name: "sandvine"
        chpasswd:
          list: |
            root:sandvine
            sandvine:sandvine
          expire: False

  # SVSDE 1
  svsde_1:
    type: OS::Nova::Server
    properties:
      name: { str_replace: { params: { $stack_name: { get_param: 'OS::stack_name' } }, template: '$stack_name-svsde-1' } }
      key_name: { get_param: 'ssh_key' }
      image: { get_param: 'svsde_image' }
      flavor: "m1.medium"
      networks:
        - port: { get_resource: svsde_ctrl_port }
        - port: { get_resource: svsde_srvc_port }
      user_data_format: RAW
      user_data: |
        #cloud-config
        system_info:
          default_user:
            name: "sandvine"
        chpasswd:
          list: |
            root:sandvine
            sandvine:sandvine
          expire: False

outputs:
